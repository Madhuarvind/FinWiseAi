{
  "entities": {
    "Transaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Transaction",
      "type": "object",
      "description": "Represents a financial transaction.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the transaction."
        },
        "transactionDate": {
          "type": "string",
          "description": "The date and time when the transaction occurred.",
          "format": "date-time"
        },
        "description": {
          "type": "string",
          "description": "A textual description of the transaction (e.g., 'Starbucks - $12.50')."
        },
        "amount": {
          "type": "number",
          "description": "The monetary amount of the transaction."
        },
        "categoryId": {
          "type": "string",
          "description": "Reference to the Category. (Relationship: Category 1:N Transaction)"
        },
        "userProfileId": {
          "type": "string",
          "description": "Reference to the UserProfile. (Relationship: UserProfile 1:N Transaction)"
        },
        "confidenceScore": {
          "type": "number",
          "description": "Confidence score assigned to the transaction categorization."
        },
        "explanation": {
          "type": "string",
          "description": "Explanation of the transaction classification, potentially generated by XAI."
        }
      },
      "required": [
        "id",
        "transactionDate",
        "description",
        "amount",
        "categoryId",
        "userProfileId"
      ]
    },
    "Category": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Category",
      "type": "object",
      "description": "Represents a category for financial transactions (e.g., 'Dining', 'Fuel', 'Shopping').",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the category."
        },
        "name": {
          "type": "string",
          "description": "The name of the category (e.g., 'Dining')."
        },
        "description": {
          "type": "string",
          "description": "A description of the category."
        },
        "rules": {
          "type": "string",
          "description": "JSON containing fuzzy-matching or keyword-based rules."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user profile.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "The user's first name."
        },
        "lastName": {
          "type": "string",
          "description": "The user's last name."
        },
        "registrationDate": {
          "type": "string",
          "description": "The date and time the user registered.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information.  The `userId` parameter is the Firebase Authentication UID. Ensures path-based ownership: only the authenticated user can read/write their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID of the user."
            }
          ]
        }
      },
      {
        "path": "/categories/{categoryId}",
        "definition": {
          "entityName": "Category",
          "schema": {
            "$ref": "#/backend/entities/Category"
          },
          "description": "Stores transaction categories. Access control for creation/modification may rely on a separate admin role collection.",
          "params": [
            {
              "name": "categoryId",
              "description": "Unique identifier for the category."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/transactions/{transactionId}",
        "definition": {
          "entityName": "Transaction",
          "schema": {
            "$ref": "#/backend/entities/Transaction"
          },
          "description": "Stores financial transactions for a specific user.  Path-based ownership ensures only the authenticated user can read/write their own transactions.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID of the user."
            },
            {
              "name": "transactionId",
              "description": "Unique identifier for the transaction."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to be secure, scalable, and debuggable, adhering to the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), QAPs (Rules are not Filters), and Invariants.  The design primarily focuses on user-owned data with clear hierarchical paths and denormalization where necessary for authorization.\n\n1.  **UserProfile:** User profiles are stored under `/users/{userId}`. This path-based ownership ensures that only the authenticated user can access their profile data. This structure supports secure `list` operations because access is controlled at the collection level based on the authenticated user's ID.\n\n2.  **Categories:** Categories are stored globally under `/categories/{categoryId}`.  While the current structure doesn't explicitly define who can create/modify categories, one could create a separate `/roles_admin/{userId}` collection to grant admin privileges. Rules would check for the existence of a document in this collection.\n\n3.  **Transactions:** Transactions are stored under `/users/{userId}/transactions/{transactionId}`. This path-based ownership ensures that only the authenticated user can access their transaction data. This is a `User 1:N Transaction` relationship. No denormalization is required here, as ownership is enforced by the path.\n\n**Authorization Independence (CRITICAL):**  Authorization independence is achieved primarily through path-based ownership for user-specific data. Since each user's data is stored under their own `userId`, security rules can be written to validate that `request.auth.uid == userId` without needing to `get()` any parent documents. For categories, existence in `/roles_admin` would grant admin access.\n\n**QAPs (Rules are not Filters):** The structure supports secure `list` operations because access is controlled at the collection level based on the authenticated user's ID.  Rules can securely `list` the `/users/{userId}/transactions` collection, ensuring that only the authenticated user's transactions are returned without needing to filter based on document data.\n"
  }
}